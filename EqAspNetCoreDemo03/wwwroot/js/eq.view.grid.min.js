(function(n,t){var i=t.EQ=t.EQ||{};i.view=i.view||{};i.view.grid={_resultPanel:null,_clearQueryButton:null,_loadQueryButton:null,_saveQueryButton:null,_applyFilterButton:null,_exportButtons:null,_funcs:{},_findControlById:function(t){var i=n("#"+t);return i.length===0&&(i=null),i},_syncActionAvailable:!0,init:function(n){var u,f,e,o,s,h,c,r,l;if(n=n||t.easyQueryViewSettings||{},i.view.applyCommonOptions(n),u=n.resultPanelId||"ResultPanel",this._resultPanel=this._findControlById(u),f=n.clearQueryButtonId||"ClearQueryButton",this._clearQueryButton=this._findControlById(f),e=n.loadQueryButtonId||"LoadQueryButton",this._loadQueryButton=this._findControlById(e),o=n.saveQueryButtonId||"SaveQueryButton",this._saveQueryButton=this._findControlById(o),s=n.resultCountSpanId||"ResultCount",this._resultCountSpan=this._findControlById(s),h=n.applyFilterButtonId||"ApplyFilterButton",this._applyFilterButton=this._findControlById(h),c=n.exportButtonsId||"ResultExportButtons",this._exportButtons=this._findControlById(c),typeof n.syncQueryOnChange=="undefined"&&(n.syncQueryOnChange=!1),typeof n.applyFilterOnStart=="undefined"&&(n.applyFilterOnStart=!0),this.showChart=typeof n.showChart!="undefined"?n.showChart:!0,this.pagingOptions=n.paging,r=this,i.client.onInit=function(){n.applyFilterOnStart&&r.applyFilter()},i.client.init(),this.applyFilterUrl=n.applyFilterUrl||i.core.combinePath(i.client.serviceUrl,"ApplyFilter"),this._funcs.clearButtonClick||(this._funcs.clearButtonClick=function(){r._clearErrors();r._exportButtons&&r._exportButtons.hide();r._resultCountSpan&&r._resultCountSpan.hide();r._clearSqlPanel();i.client.clearQuery()}),this._clearQueryButton){this._clearQueryButton.off("click",this._funcs.clearButtonClick);this._clearQueryButton.on("click",this._funcs.clearButtonClick)}if(this._funcs.loadQueryButtonClick||(this._funcs.loadQueryButtonClick=function(){i.client.loadQuery({queryId:"LastQuery",success:function(){r._clearErrors();r._clearResultPanel()},error:r._errorHandler})}),this._loadQueryButton){this._loadQueryButton.off("click",this._funcs.loadQueryButtonClick);this._loadQueryButton.on("click",this._funcs.loadQueryButtonClick)}if(this._funcs.saveQueryButtonClick||(this._funcs.saveQueryButtonClick=function(){var u=i.client.getQuery(),n=u.id;n||(n="LastQuery");i.client.saveQuery({query:u,queryName:n,success:function(){t.alert("Query saved!")},error:r._errorHandler})}),this._saveQueryButton){this._saveQueryButton.off("click",this._funcs.saveQueryButtonClick);this._saveQueryButton.on("click",this._funcs.saveQueryButtonClick)}this._funcs.applyFilterButtonClick||(this._funcs.applyFilterButtonClick=function(){r.applyFilter({page:1})});i.client.controls.FBWidget&&i.client.controls.FBWidget.FilterBar("option","applyFilterCallback",this._funcs.applyFilterButtonClick);this._funcs.queryChangedHandler||(this._funcs.queryChangedHandler=function(){n.syncQueryOnChange&&n.rebuildOnQueryChange&&(r._syncActionAvailable?r.syncQuery():r.buildQuery())});l=i.client.getQuery();l.addChangedCallback(this._funcs.queryChangedHandler)},_clearErrorsInPanel:function(n){n&&(n.hasClass("error")&&n.removeClass("error"),n.empty())},_clearErrors:function(){this._clearErrorsInPanel(this._resultPanel)},_clearResultPanel:function(){this._resultPanel&&this._resultPanel.empty();this._exportButtons&&this._exportButtons.hide();this._resultCountSpan&&this._resultCountSpan.hide()},syncQuery:function(){var n=this;i.client.syncQuery({beforeSend:function(){},success:function(){},error:function(){}})},applyFilter:function(t){var u=this,f,e,c=i.client.getQuery(),o=n("<div><\/div>",{"class":"result-panel loader"}),s,h,r;t=t||{};t.page||(s=u.getCurrentPaging(),t.page=s.page);h={query:c.getQueryObject(),options:t};r=u._resultPanel;n.ajax({type:"POST",contentType:"application/json",url:u.applyFilterUrl,data:JSON.stringify(h),beforeSend:function(){r&&(r.animate({opacity:"0.5"},200),r.html(o))},success:function(t){var s,a,h,v,c,l;try{r&&(t.resultSet?(r.empty(),t.resultSet.table?s=i.view.renderGridOldStyle(t.resultSet.table):(a=i.view.getDataTableClass(),h=new a(t.resultSet),u.showChart&&(v=n("<div />").addClass("chart-panel").css({float:"right"}).appendTo(r),i.view.drawChart(h,v.get(0))),s=i.view.renderGridByDataTable(h)),c=n("<div />").addClass("grid-panel").appendTo(r),c.append(s),u._exportButtons&&u._exportButtons.show(),f=result.paging,f&&f.enabled&&f.pageCount>1&&(e=i.view.renderPageNavigator({pageIndex:f.pageIndex,pageCount:f.pageCount,pageSelectedCallback:function(n){u.buildAndExecute({page:n})},maxButtonCount:u.pagingOptions?u.pagingOptions.maxButtonCount:null,cssClass:u.pagingOptions?u.pagingOptions.cssClass:null}),c.css("height",r.innerHeight()-30),e.appendTo(r)),r.animate({opacity:1},200)):(r.html(t),f=u.getCurrentPaging(),f.pageCount>1&&(l=n("#PageNavigator"),l.length>0&&(e=i.view.renderPageNavigator({pageIndex:f.pageIndex,pageCount:f.pageCount,pageSelectedCallback:function(n){u.applyFilter({page:n})}}),l.append(e))),r.animate({opacity:1},200)));result.resultCount&&(u._resultCountSpan.text(result.resultCount),u._resultCountSpan.show())}finally{o.remove()}},error:function(n,t,i){o.remove();r&&(r.empty(),r.append("<div><\/div>").addClass("error").append("<div>Error during "+i+" request:  <div>"+t+"<\/div><\/div>"))}})},getCurrentPaging:function(){var t,i,r;return result={pageIndex:1,pageCount:1},t=n("#PageNavigator"),t.length>0&&(i=t.data("pageindex"),r=t.data("pagecount"),i&&(result.pageIndex=i),r&&(result.pageCount=r)),result}};n(function(){i.view.grid.init()})})(jQuery,window);